<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lead Form</title>
  <style>
    .ava-form-wide {
      width: 100%;
      max-width: 960px;
      background: #f7f9fc;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      font-family: 'Helvetica Neue', Arial, sans-serif;
      text-align: center;
      margin: 10px auto;
    }
    .ava-form-wide h1 { font-size: 30px; font-weight: 500; margin-bottom: 20px; color: #333; }
    .ava-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px; }
    .ava-col { flex: 1 1 45%; min-width: 240px; }
    .ava-full { flex: 1 1 100%; }
    .ava-col input, .ava-full input {
      width: 100%; padding: 14px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
    }
    .g-recaptcha { margin: 0 auto; }
    .ava-submit-btn {
      width: 100%; max-width: 240px; padding: 14px; font-size: 16px; font-weight: 500;
      background-color: #0069e1; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin: 0 auto; display: block;
    }
    .ava-submit-btn:hover { background-color: #0057ba; }
    .ava-hidden { position: absolute; left: -9999px; top: -9999px; opacity: 0; pointer-events: none; }
    @media (max-width:600px){
      .ava-col,.ava-full{ flex:1 1 100% }
      .ava-form-wide h1{ font-size:24px }
      .g-recaptcha{ transform:scale(0.88); transform-origin:0 0 }
    }
  </style>
</head>
<body>
<div style="display:flex; justify-content:center; padding:10px;">
  <div class="ava-form-wide">
    <h1>-Get A Free Quote-</h1>

    <!-- Button-gated submit -->
    <form id="WebToLeadForm" action="https://stsrecycling.sugarondemand.com/index.php?entryPoint=WebToLeadCapture" method="POST">
      <div class="ava-row">
        <div class="ava-col">
          <input type="text" id="first_name" name="first_name" placeholder="First Name*" required />
        </div>
        <div class="ava-col">
          <input type="text" id="last_name" name="last_name" placeholder="Last Name*" required />
        </div>
      </div>

      <div class="ava-row">
        <div class="ava-col">
          <input type="text" id="phone_work" name="phone_work" placeholder="Office Phone*" required />
        </div>
        <div class="ava-col">
          <input type="text" id="account_name" name="account_name" placeholder="Company Name*" required />
        </div>
      </div>

      <div class="ava-row">
        <div class="ava-full">
          <input type="email" id="email" name="email" placeholder="Email Address*" required />
        </div>
      </div>

      <div class="ava-row">
        <div class="ava-full">
          <input type="text" id="description" name="description" placeholder="Pickup Notes / Request Details" />
        </div>
      </div>

      <!-- Tracking -->
      <input type="hidden" id="hint_account_description" name="hint_account_description" />
      <input type="hidden" id="lead_source_description" name="lead_source_description" />
      <input type="hidden" id="form_timestamp" name="form_timestamp" />

      <!-- Honeypots -->
      <div class="ava-hidden">
        <input type="text" id="company_location_fake" name="company_location_fake" autocomplete="off" tabindex="-1" />
        <input type="text" id="sic_code" name="sic_code" autocomplete="off" tabindex="-1" />
        <input type="email" id="confirm_email" name="confirm_email" autocomplete="off" tabindex="-1" />
        <input type="checkbox" id="subscribe_newsletter" name="subscribe_newsletter" tabindex="-1" />
        <input type="hidden" id="email_opt_in" name="email_opt_in" value="on" />
      </div>

      <!-- JS token + time trap -->
      <input type="hidden" id="js_token_name" name="js_token_name" />
      <input type="hidden" id="js_token_value" name="js_token_value" />
      <input type="hidden" id="form_rendered_at" name="form_rendered_at" />
      <input type="hidden" id="form_submitted_at" name="form_submitted_at" />

      <!-- SugarCRM -->
      <input type="hidden" name="campaign_id" value="793ae3dc-6be2-11f0-ab0d-e91717db1722" />
      <input type="hidden" name="redirect_url" value="https://www.stselectronicrecyclinginc.com/thank-you-midwest-2" />
      <input type="hidden" name="redirectRequestType" value="GET" />
      <input type="hidden" name="redirectIncludeParams" value="0" />
      <input type="hidden" name="assigned_user_id" value="c459daee-58d2-42f6-b307-8ad8a8189964" />
      <input type="hidden" name="team_set_id" value="1" />
      <input type="hidden" name="req_id" value="last_name;" />

      <!-- reCAPTCHA and Submit Button Row -->
      <div class="ava-row" style="align-items: center; justify-content: center;">
        <div class="ava-col" style="flex: 0 0 auto;">
          <div class="g-recaptcha" data-sitekey="6Ld0cZIrAAAAAPgYU8rbR2gOP6FMdB1g-9e5uH1O" data-callback="onRecaptchaValidated" data-expired-callback="onRecaptchaExpired"></div>
          <div id="recaptcha-feedback" style="display:none; color:#c0392b; margin:8px 0;">Please complete the reCAPTCHA verification.</div>
        </div>
        <div class="ava-col" style="flex: 0 0 auto;">
          <button type="button" class="ava-submit-btn" onclick="submitForm()">Submit</button>
        </div>
      </div>

      <div style="margin-top: 10px;">
        <em style="font-size: 12px; color: #666;">Powered by STS Electronic Recycling</em>
      </div>

    </form>
  </div>
</div>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
  // --- iframe auto-resize: tell parent our height ---
  function sendHeight(){
    const h = document.documentElement.scrollHeight || document.body.scrollHeight;
    window.parent && window.parent.postMessage({ type:"setFormHeight", height:h }, "*");
  }
  window.addEventListener("load", sendHeight);
  window.addEventListener("resize", sendHeight);
  new MutationObserver(sendHeight).observe(document.body, { childList:true, subtree:true, attributes:true });

  // --- form protection state ---
  const MIN_SECONDS = 3;
  let formStartTime = Date.now();
  let isCaptchaValidated = false;
  let keystrokes = 0, mouseMovements = 0;
  function rand(n){ return Math.random().toString(36).slice(2, 2 + (n||8)); }

  // reCAPTCHA callbacks
  function onRecaptchaValidated(){ isCaptchaValidated = true; document.getElementById('recaptcha-feedback').style.display='none'; setSubmitEnabled(true); sendHeight(); }
  function onRecaptchaExpired(){ isCaptchaValidated = false; document.getElementById('recaptcha-feedback').style.display='block'; setSubmitEnabled(false); sendHeight(); }

  function setSubmitEnabled(enabled){
    const btn = document.querySelector('.ava-submit-btn');
    btn.disabled = !enabled;
    btn.style.opacity = enabled ? '1' : '0.6';
    btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
  }

  function submitForm(){
    const form = document.getElementById('WebToLeadForm');

    // honeypots
    const hpHits =
      (document.getElementById('company_location_fake').value || '').trim() !== '' ||
      (document.getElementById('sic_code').value || '').trim() !== '' ||
      (document.getElementById('confirm_email').value || '').trim() !== '' ||
      document.getElementById('subscribe_newsletter').checked;
    if (hpHits) return false;

    // time trap
    const elapsed = (Date.now() - formStartTime) / 1000;
    document.getElementById('form_submitted_at').value = String(Date.now());
    if (elapsed < MIN_SECONDS){ alert('Please take a moment to review your information.'); return false; }

    // minimal human activity
    if (keystrokes < 1 && mouseMovements < 1){ alert('Please ensure all fields are properly filled.'); return false; }

    // email format
    const email = document.getElementById('email').value;
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(email)){ alert('Please enter a valid email address.'); return false; }

    // captcha
    const recaptchaResponse = (window.grecaptcha && grecaptcha.getResponse()) || '';
    if (!isCaptchaValidated || !recaptchaResponse){
      document.getElementById('recaptcha-feedback').style.display='block';
      alert('Please complete the reCAPTCHA verification before submitting.');
      return false;
    }

    // token
    const tName = document.getElementById('js_token_name').value;
    const tVal  = document.getElementById('js_token_value').value;
    if (!tName || !/^[A-Za-z0-9_.-]+$/.test(tVal)) return false;

    // Submit the form normally, but try to redirect the parent window
    form.target = "_parent"; // Try to submit to parent window instead of iframe
    form.submit();
    return true;
  }

  document.addEventListener('DOMContentLoaded', async function () {
    setSubmitEnabled(false);
    document.addEventListener('keydown', ()=> keystrokes++);
    document.addEventListener('mousemove', ()=> mouseMovements++);

    // Simple approach - just capture the referrer domain or iframe URL
    const sourceUrl = document.referrer || window.location.href;
    document.getElementById('lead_source_description').value = sourceUrl;
    document.getElementById('form_timestamp').value = String(Date.now());
    document.getElementById('form_rendered_at').value = String(formStartTime);

    const tokenName = 'tok_' + rand(6);
    const tokenVal  = [rand(6), Date.now().toString(36), rand(6)].join('.');
    document.getElementById('js_token_name').value = tokenName;
    document.getElementById('js_token_value').value = tokenVal;

    try {
      const res = await fetch("https://ipapi.co/json");
      const data = await res.json();
      if (data && data.city) document.getElementById('hint_account_description').value = data.city;
    } catch(e){ console.error("IP location fetch failed."); }

    sendHeight();
  });
</script>
</body>
</html>
